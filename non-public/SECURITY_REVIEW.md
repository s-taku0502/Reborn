# セキュリティレビュー（現状と改善）

## 1. 未対策 / 脆弱になり得る点（現状）

- **CSP未設定**により、XSSの影響範囲が広がる可能性
- **入力値の長さ・制御文字の制限不足**（メモ/場所）
- **画像URLの許可ドメイン制御が弱い**（今後の拡張時に外部URLが混入する可能性）
- **重要操作のレート制限不足**（ログイン・復元の試行回数に関する防御が限定的）
- **サーバー側検証がログイン以外に未適用**（サインアップ/保存はクライアント実行）
- **localStorageに秘密情報が存在**（XSS成立時に取得される恐れ）

## 2. すでに実装済みの対策

- Firestore利用により **SQLインジェクションは非該当**
- Reactの自動エスケープを利用（`dangerouslySetInnerHTML`不使用）
- バックアップパスワードは **bcryptハッシュ化**
- 復元処理は **3ストライク + ロック**

## 3. 今回追加した改善（実装済み）

- **セキュリティヘッダー + CSP** を追加
  - `Content-Security-Policy`, `X-Frame-Options`, `X-Content-Type-Options`, `Referrer-Policy`, `Permissions-Policy`
  - 本番環境では `unsafe-eval` を無効化
- **メモ/場所の入力サニタイズ + 文字数制限**
  - 制御文字除去 + 50/200文字制限
  - 保存前にバリデーションを実施
- **ログイン試行のレート制限（クライアント側）**
  - 連続失敗 **5回** で **15分ロック**
  - `localStorage` に試行情報を保持
- **サーバー側ログイン検証 + IP/時間ベースのレート制限**
  - `/api/auth/login` で検証し、Cloud Firestore のユーザー情報を参照
  - IP+ユーザーID単位で失敗回数をカウント（15分ウィンドウ）
  - 5回失敗で15分ロック（429）
- **サーバー側サインアップAPI + レート制限**
  - `/api/auth/signup` でユーザー登録を検証
  - IP単位で1時間に10回まで（429）
- **サーバー側ログ保存API + レート制限**
  - `/api/logs/save` でログ保存を検証
  - ユーザー単位で1時間に100回まで（429）
  - 入力サニタイズ（memo, location）
- **画像URLの許可リスト化**
  - `res.cloudinary.com` + 自分の `cloudName` + `sanposhin/{userId}` のみ許可
  - 不正URLは表示をブロック

## 4. 追加で推奨される改善（次段階）

- **CSPの段階的厳格化**（`unsafe-inline` を nonce/hash に置き換え）
- **依存パッケージ監査**（`npm audit` の定期実行、Dependabot導入）
- **HTTPSの強制**（本番環境での HSTS 設定）
- **Cloudinary削除APIの実装**（アカウント削除時の画像一括削除）
- **ログ監視・異常検知**（大量保存・異常ログインの検知）

## 5. 影響範囲と確認ポイント

- **CSP導入**により、外部リソースがブロックされる可能性
  - Cloudinary画像、Firebase通信が通ることを確認
- **入力制限**により、想定以上に長い入力が保存されない

---

このファイルは、要件定義とは独立した「現状評価 + 改善ログ」です。
