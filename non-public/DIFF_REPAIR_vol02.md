# 差異修復レポート（DIFF_REPAIR）

## 対象

* 差異レポート: REQUIREMENTS_DIFF.md
* 対応項目: **🔴 重大な差異 1. パスワード再設定（新規発行）機能**

## 実施日

2026年2月1日

---

## 1. 修復方針（実装）

### ゴール

* **ログイン中ユーザーのみ**が実行可能
* **既存パスワードの確認・表示は行わない**
* **新しい7文字パスワードを設定した時点で旧パスワードは即時無効化**
* 再設定完了時に**一度だけ新パスワードを通知**（表示）

### セキュリティ前提

* 平文パスワードは**保存しない**
* 保存するのは**ハッシュのみ**（`sanposhin_password_hash`）

---

## 2. 実装内容（要約）

### UI 追加（マイページ）

* 「パスワードを再設定」ボタンを追加
* 確認ダイアログを表示（取り消し可能）

### 処理フロー

1. ログイン状態を検証（`sanposhin_userId` の存在）
2. 新しい7文字パスワードを生成
3. bcrypt でハッシュ化
4. `sanposhin_password_hash` を**上書き保存**（旧ハッシュ無効化）
5. 新パスワードを**一度だけ表示**し、控えを促す

### 疑似コード

```ts
import bcrypt from 'bcryptjs';

const handlePasswordReset = async () => {
  // 1. ログインチェック
  const userId = localStorage.getItem('sanposhin_userId');
  if (!userId) {
    showErrorNotification('ログイン中のユーザーのみ実行できます');
    return;
  }

  // 2. 新規パスワード生成（7文字）
  const newPassword = generatePassword(7);

  // 3. ハッシュ化して保存（上書き）
  const hash = await bcrypt.hash(newPassword, 10);
  localStorage.setItem('sanposhin_password_hash', hash);

  // 4. 一度だけ通知
  showSuccessNotification(`新しいパスワードです。必ず控えてください：\n${newPassword}`);
};
```

---

## 3. 検証観点（チェックリスト）

* [ ] ログインしていない場合、再設定できない
* [ ] 既存パスワードの表示・確認が行われない
* [ ] 再設定後、**旧パスワードでログイン不可**
* [ ] 新パスワードでログイン可能
* [ ] ローカルストレージに**平文パスワードが存在しない**

---

## 4. 要件定義への反映（修正点）

> 本対応により、要件定義 §4.3.3 は**内容を明確化**する修正が必要。

### 修正前（抜粋｜§4.3.3）

```
- ログイン中のユーザーのみ実行可能
- 既存パスワードの確認（表示）は一切行わない
- 新しい7文字パスワードを設定した時点で、旧パスワードは即時無効化
```

### 修正後（反映案｜§4.3.3）

```
- ログイン中のユーザーのみ実行可能
- 既存パスワードの確認・表示・復元は一切行わない
- パスワードは平文で保存せず、ハッシュ化したもののみを保持する
- 新しい7文字パスワードを設定した時点で、旧パスワードは即時無効化する
- 再設定完了時に限り、新パスワードを一度だけユーザーに表示する
```

※ 本修正は **セキュリティ要件の明文化**であり、要件の後退ではありません。

---

## 5. 関連差異への影響

* 差異 2（平文保存）・差異 3（バックアップに含有）は**本対応のみでは未解消**
* ただし、**再設定後は平文を扱わない設計**に統一され、後続修正の前提が整う

---

## 6. ステータス

* 対応範囲（差異 1）: **修復完了**
* 次対応候補: 差異 2 → 差異 3（Phase 1 継続）

---

## 7. 対応方法（REQUIREMENTS_DIFF_vol02 対応指針）

本章では、`REQUIREMENTS_DIFF_vol02.md` に記載された差異に対する**公式な対応方法（実装・設計レベル）**を整理する。
本内容は「修正案」ではなく、**以降の実装判断の正**として扱う。

---

### 7.1 対応済み項目（Phase 1）

以下の差異は **実装・要件ともに確定済み** であり、追加対応は不要とする。

| 差異ID | 内容              | 対応方法                             | 状態 |
| ---- | --------------- | -------------------------------- | -- |
| 🔴-1 | パスワード再設定（新規発行）  | §4.3.3 を更新し、再設定＝再発行に一本化          | 完了 |
| 🔴-3 | バックアップへのパスワード含有 | バックアップ仕様から password / hash を完全除外 | 完了 |

---

### 7.2 部分解消項目の対応方法（Phase 2 優先）

#### 7.2.1 パスワード保存方法（差異🔴-2）

**対応方針**

* Firestore・localStorage を問わず、

  * 平文パスワードは一切保存しない
  * 保存対象はハッシュのみとする

**追加対応**

* 既存端末に平文が残っている場合でも

  * 次回ログイン or 再設定時に必ずハッシュへ移行
* 移行完了後、平文キーは削除

---

#### 7.2.2 復元機能（差異🟡-4）

**対応方針**

* 復元は「ユーザーID + パスワード一致」のみで許可
* セキュリティ担保のため以下を必須実装とする

**実装要件**

* 復元失敗回数を localStorage に保持
* 3回連続失敗で 60分ロック
* ロック中は復元処理自体を拒否

```ts
interface RestoreAttempt {
  failureCount: number;
  lockUntil?: number; // Unix time
}
```

---

### 7.3 未解消項目の対応方法（設計確定）

#### 7.3.1 Firebase（Firestore）連携（差異🔴-5）

**対応方針**

* Firestore を SSOT（Single Source of Truth）とする
* localStorage はキャッシュ扱い

**最低実装範囲（Phase 2）**

* ユーザーID一意チェック
* ユーザープロフィール保存
* ログの永続化
* バックアップ・復元の基準データ

---

#### 7.3.2 アカウント削除（差異🔴-6）

**対応方針**

* GDPR/個人データ観点から削除機能は必須

**仕様確定**

* マイページに「アカウント削除」ボタンを設置
* 削除対象

  * Firestore 上の user ドキュメント
  * localStorage 全キー

---

#### 7.3.3 エラーハンドリング（差異🔴-7）

**対応方針**

* 技術的エラーをそのまま表示しない
* ユーザー向けメッセージを定義

**必須対応**

* ネットワークエラー
* ストレージ容量不足
* Firestore 接続失敗

---

### 7.4 軽微差異の対応方針（MVP外・後続）

| 差異          | 方針                         |
| ----------- | -------------------------- |
| Cloudinary  | Phase 3 で導入、MVPは Base64 継続 |
| Geolocation | MVP対象外（§2 により不要）           |
| SNS共有 / AI  | 拡張スコープとして凍結                |
| i18n        | 日本語固定で確定                   |

---

## 8. 本ドキュメントの位置づけ

* 本書（DIFF_REPAIR / REQUIREMENTS_DIFF_vol02）は

  * **要件定義の修正履歴**
  * **実装判断の正解集**
  * **レビュー・審査時の説明資料**
    となる

* 実装時に要件と差異が生じた場合は

  * 本ドキュメントを更新し
  * requirements_definition.md に反映する

---

**ステータス**: 🟢 Phase 1 完全収束 / Phase 2 実装判断確定

